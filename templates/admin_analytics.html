{% extends 'admin_base.html' %}
{% block title %}Analytics Dashboard{% endblock %}
{% block content %}
<h1 class="mb-4">
  <i class="bi bi-bar-chart-line"></i>
  Analytics Dashboard <span class="fs-5 text-muted">| Insights & Trends</span>
</h1>

<!-- Filter Bar -->
<form
  method="get"
  class="row g-2 mb-4 align-items-end"
  aria-label="Dashboard filters"
>
  <div class="col-12 col-md-2">
    <label for="start_date" class="form-label mb-1"><i class="bi bi-calendar-date"></i> Custom Start</label>
    <input
      type="date"
      id="start_date"
      name="start_date"
      value="{{ start_date }}"
      class="form-control"
      aria-label="Start date"
    />
  </div>
  <div class="col-12 col-md-2">
    <label for="end_date" class="form-label mb-1"><i class="bi bi-calendar-date"></i> Custom End</label>
    <input
      type="date"
      id="end_date"
      name="end_date"
      value="{{ end_date }}"
      class="form-control"
      aria-label="End date"
    />
  </div>
  <div class="col-12 col-md-8">
    <label class="form-label mb-1"><i class="bi bi-clock-history"></i> Quick Ranges</label><br />
    <div class="btn-group" role="group" aria-label="Select period">
      <button
        type="submit"
        name="period"
        value="all"
        class="btn btn-sm {% if period == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %} me-1"
      >
        All Time
      </button>
      {% for p in periods if p != 'all' %}
      <button
        type="submit"
        name="period"
        value="{{ p }}"
        class="btn btn-sm {% if period == p %}btn-primary{% else %}btn-outline-primary{% endif %} me-1"
      >
        Last {{ p }} days
      </button>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-success btn-sm ms-2">
      <i class="bi bi-funnel"></i> Apply
    </button>
  </div>
</form>

<!-- Summary Cards -->
<div class="row mb-4 g-3">
  <div class="col-6 col-md-3">
    <div class="card text-white bg-info mb-3 shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="card-title"><i class="bi bi-people-fill"></i> Total Users</h6>
        <h2 class="display-5 fw-bold">{{ total_users }}</h2>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-white bg-primary mb-3 shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="card-title"><i class="bi bi-person-check-fill"></i> Active Users</h6>
        <h2 class="display-5 fw-bold">{{ active_users }}</h2>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-white bg-success mb-3 shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="card-title"><i class="bi bi-award-fill"></i> Avg Exam Score</h6>
        <h2 class="display-5 fw-bold">{{ avg_exam_score }}%</h2>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-dark bg-warning mb-3 shadow-sm border-0 h-100">
      <div class="card-body text-center">
        <h6 class="card-title"><i class="bi bi-journal-check"></i> Avg Course Progress</h6>
        <h2 class="display-5 fw-bold">{{ avg_course_progress }}%</h2>
      </div>
    </div>
  </div>
</div>

<!-- Top Users Table -->
<div class="card mb-5 shadow-sm border-0">
  <div
    class="card-header bg-light fw-bold d-flex align-items-center justify-content-between"
  >
    <span><i class="bi bi-trophy"></i> Top 5 Users by Exam Score</span>
    <a
      href="{{ url_for('admin_routes.analytics_user_list') }}"
      class="btn btn-sm btn-outline-secondary"
      ><i class="bi bi-list-ul"></i> View All Users</a
    >
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Department</th>
            <th>Avg Score</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% if top_users %} {% for u, avg_score in top_users %}
          <tr>
            <td>
              <div class="d-flex align-items-center gap-2">
                <span
                  class="rounded-circle bg-secondary d-inline-block text-white text-center"
                  style="
                    width: 32px;
                    height: 32px;
                    line-height: 32px;
                    font-weight: bold;
                  "
                  title="{{ u.first_name }} {{ u.last_name }}"
                >
                  {{ u.first_name|first }}{{ u.last_name|first }}
                </span>
                <span>{{ u.first_name }} {{ u.last_name }}</span>
              </div>
            </td>
            <td><i class="bi bi-envelope-at"></i> {{ u.employee_email }}</td>
            <td><i class="bi bi-building"></i> {{ u.department.name if u.department else '-' }}</td>
            <td>
              <span class="badge bg-success">{{ avg_score|round(2) }}%</span>
            </td>
            <td>
              <a
                href="{{ url_for('admin_routes.analytics_user_detail', user_id=u.id) }}"
                class="btn btn-sm btn-outline-primary"
                aria-label="View user details"
              >
                <i class="bi bi-search"></i> View
              </a>
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted">
              No user exam scores found for this period.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Data Visualizations -->
<div class="row mb-5 g-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header fw-bold bg-light"><i class="bi bi-bar-chart-steps"></i> Average Exam Scores</div>
      <div class="card-body">
        <canvas
          id="examChart"
          height="180"
          aria-label="Average Exam Scores"
        ></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header fw-bold bg-light"><i class="bi bi-pie-chart-fill"></i> Pass vs Fail</div>
      <div class="card-body text-center">
        <span class="badge bg-success fs-6 me-3"><i class="bi bi-check-circle-fill"></i> Passed: {{ pass_pct }}%</span>
        <span class="badge bg-danger fs-6"><i class="bi bi-x-circle-fill"></i> Failed: {{ fail_pct }}%</span>
        <div class="my-3">
          <canvas
            id="passFailChart"
            height="140"
            style="max-width: 280px; margin: auto"
          ></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-5 g-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header fw-bold bg-light"><i class="bi bi-graph-up-arrow"></i> Course Progress</div>
      <div class="card-body">
        <canvas
          id="courseChart"
          height="180"
          aria-label="Course Progress"
        ></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header fw-bold bg-light">
        <i class="bi bi-trending-up"></i> Score Trend {% if period == 'all' %} (All Time) {% else %} (Last {{
        period }} Days) {% endif %}
      </div>
      <div class="card-body">
        <canvas id="trendChart" height="180" aria-label="Score Trend"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- 3D Scatter Plot with Axis & Color Selection and Explanations -->
<div class="row mb-5 g-4">
  <div class="col-lg-9 col-12">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header fw-bold bg-light d-flex justify-content-between align-items-center">
        <span><i class="bi bi-scatter-chart"></i> 3D User Analytics: Explore Relationships</span>
        <div class="d-flex gap-2 align-items-center">
          <label class="form-label mb-0">X:</label>
          <select id="scatter-x" class="form-select form-select-sm" style="width:auto">
            {% for opt in axis_options %}
            <option value="{{ opt.key }}" {% if opt.key == default_x %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
          </select>
          <label class="form-label mb-0">Y:</label>
          <select id="scatter-y" class="form-select form-select-sm" style="width:auto">
            {% for opt in axis_options %}
            <option value="{{ opt.key }}" {% if opt.key == default_y %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
          </select>
          <label class="form-label mb-0">Z:</label>
          <select id="scatter-z" class="form-select form-select-sm" style="width:auto">
            {% for opt in axis_options %}
            <option value="{{ opt.key }}" {% if opt.key == default_z %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
          </select>
          <label class="form-label mb-0">Color:</label>
          <select id="scatter-color" class="form-select form-select-sm" style="width:auto">
            <option value="department" selected>Department</option>
            {% for opt in axis_options %}
            <option value="{{ opt.key }}">{{ opt.label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="card-body">
        <div id="scatter3d" style="height:400px;"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-12">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-light fw-bold"><i class="bi bi-info-circle"></i> What does this chart show?</div>
      <div class="card-body small">
        <ul class="mb-2">
          <li><strong>Each point</strong>: A user</li>
          <li><strong>X, Y, Z axes</strong>: Select metrics to compare (see below)</li>
          <li><strong>Color</strong>: Group users by department or metric</li>
          <li><strong>Hover</strong>: See user name and values</li>
        </ul>
        <div>
          <strong>Metric explanations:</strong>
          <ul class="ps-3 mb-0">
            <li><strong>Avg Exam Score:</strong> Mean exam score for user</li>
            <li><strong>Total Time Spent:</strong> Sum of time studying/training</li>
            <li><strong>Completion Rate:</strong> % of assigned courses finished</li>
            <li><strong>Exams Taken:</strong> Number of exams attempted</li>
            <li><strong>Avg Attempts per Exam:</strong> Mean attempts per unique exam</li>
            <li><strong>Score Improvement:</strong> Most recent minus first exam score</li>
            <li><strong>Last Activity (days ago):</strong> Days since last activity</li>
            <li><strong>Department:</strong> User's department</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Plotly.js (Latest) -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
  // All metrics as arrays keyed by metric name
  const metrics = {{ metrics|tojson }};
  const user_labels = metrics.user_labels;
  const departments = metrics.department;

  // Generate a color map for departments
  function getDeptColorMap(departments) {
    const unique = Array.from(new Set(departments));
    const palette = [
      "#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f",
      "#edc949", "#af7aa1", "#ff9da7", "#9c755f", "#bab0ab"
    ];
    let map = {};
    unique.forEach((d, i) => map[d] = palette[i % palette.length]);
    return map;
  }

  function getAxisLabel(key) {
    const opts = {{ axis_options|tojson }};
    if(key === "department") return "Department";
    return (opts.find(o => o.key === key) || {}).label || key;
  }

  function drawScatter3D(xkey, ykey, zkey, colorKey) {
    let marker = { size: 8, opacity: 0.9, line: { width: 1, color: '#333' } };
    let colors, colorTitle, showscale = false, colorBar = undefined;

    if(colorKey === "department") {
      // Color by department
      const deptMap = getDeptColorMap(departments);
      colors = departments.map(dep => deptMap[dep]);
      colorTitle = "Department";
      marker.color = colors;
      marker.colorscale = undefined;
      marker.showscale = false;
      // Create legend traces for departments
      let data = [];
      for(const dept in deptMap) {
        let idxs = departments.map((d,i) => d===dept?i:-1).filter(i=>i!==-1);
        data.push({
          x: idxs.map(i=>metrics[xkey][i]),
          y: idxs.map(i=>metrics[ykey][i]),
          z: idxs.map(i=>metrics[zkey][i]),
          mode: 'markers',
          type: 'scatter3d',
          name: dept,
          text: idxs.map(i=>user_labels[i]),
          marker: {...marker, color: deptMap[dept]},
        });
      }
      var layout = {
        scene: {
          xaxis: { title: getAxisLabel(xkey) },
          yaxis: { title: getAxisLabel(ykey) },
          zaxis: { title: getAxisLabel(zkey) }
        },
        legend: { title: {text:"Department"}, orientation: "v" },
        margin: { l:0, r:0, b:0, t:30 }
      };
      Plotly.newPlot('scatter3d', data, layout, {responsive: true});
      return;
    } else {
      // Color by metric
      marker.color = metrics[colorKey];
      marker.colorscale = 'Viridis';
      marker.colorbar = { title: getAxisLabel(colorKey) };
      marker.showscale = true;
      marker.cmin = Math.min(...metrics[colorKey]);
      marker.cmax = Math.max(...metrics[colorKey]);
    }

    var trace = {
      x: metrics[xkey],
      y: metrics[ykey],
      z: metrics[zkey],
      mode: 'markers',
      type: 'scatter3d',
      text: user_labels,
      marker: marker
    };
    var layout = {
      scene: {
        xaxis: { title: getAxisLabel(xkey) },
        yaxis: { title: getAxisLabel(ykey) },
        zaxis: { title: getAxisLabel(zkey) }
      },
      margin: { l:0, r:0, b:0, t:30 }
    };
    Plotly.newPlot('scatter3d', [trace], layout, {responsive: true});
  }

  const xSel = document.getElementById('scatter-x');
  const ySel = document.getElementById('scatter-y');
  const zSel = document.getElementById('scatter-z');
  const cSel = document.getElementById('scatter-color');

  function updateScatter() {
    drawScatter3D(xSel.value, ySel.value, zSel.value, cSel.value);
  }
  xSel.addEventListener('change', updateScatter);
  ySel.addEventListener('change', updateScatter);
  zSel.addEventListener('change', updateScatter);
  cSel.addEventListener('change', updateScatter);

  // Initial plot
  drawScatter3D(xSel.value, ySel.value, zSel.value, cSel.value);
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Prepare data
  const examLabels     = {{ exam_labels|tojson }};
  const examScores     = {{ exam_avg_scores|tojson }};
  const courseLabels   = {{ course_labels|tojson }};
  const courseProgress = {{ course_avg_progress|tojson }};
  const passCount      = {{ passed_count }};
  const failCount      = {{ failed_count }};
  const trendLabels    = {{ ts_labels|tojson }};
  const trendScores    = {{ ts_avg_scores|tojson }};

  document.addEventListener('DOMContentLoaded', () => {
    // Average Exam Scores Bar Chart
    new Chart(document.getElementById('examChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: examLabels,
        datasets: [{
          label: 'Avg Score (%)',
          data: examScores,
          backgroundColor: '#3498db',
          borderRadius: 6,
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        scales: { x: { beginAtZero: true, max: 100 } },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.x}%` } }
        }
      }
    });

    // Pass vs Fail Doughnut
    new Chart(document.getElementById('passFailChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Passed', 'Failed'],
        datasets: [{
          data: [passCount, failCount],
          backgroundColor: ['#27ae60', '#e74c3c'],
          hoverOffset: 8,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        cutout: '65%',
        plugins: {
          legend: { display: true, position: 'bottom' }
        }
      }
    });

    // Course Progress Bar Chart
    new Chart(document.getElementById('courseChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: courseLabels,
        datasets: [{
          label: 'Avg Progress (%)',
          data: courseProgress,
          backgroundColor: '#f39c12',
          borderRadius: 6,
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        scales: { x: { beginAtZero: true, max: 100 } },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.x}%` } }
        }
      }
    });

    // Score Trend Line Chart
    new Chart(document.getElementById('trendChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Avg Score',
          data: trendScores,
          fill: true,
          borderColor: '#8e44ad',
          backgroundColor: 'rgba(142,68,173,0.1)',
          tension: 0.25,
          pointBackgroundColor: '#8e44ad',
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: {
          legend: { display: true, position: 'top' }
        }
      }
    });
  });
</script>
{% endblock %}