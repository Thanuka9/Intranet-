<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ study_material.title }} - Course Details</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #f2f6fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .page-wrapper {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .content-wrapper {
        flex: 1 0 auto;
      }
      .top-bar {
        background-color: #fff;
        padding: 10px 30px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .brand {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .brand .black {
        color: #000;
      }
      .brand .red {
        color: red;
      }
      .course-header {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      .course-header h1 {
        font-size: 2rem;
        font-weight: 600;
      }
      .pdf-viewer {
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fff;
        width: 100%;
      }
      .nav-controls {
        margin: 10px 0;
        text-align: center;
      }
      .progress {
        height: 28px;
        border-radius: 14px;
        background-color: #e9ecef;
      }
      .progress-bar {
        background-color: #28a745;
        border-radius: 14px;
      }
      footer.bg-dark {
        flex-shrink: 0;
      }
    </style>
  </head>

  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <a
        href="{{ url_for('study_material_routes.list_study_materials') }}"
        class="btn btn-secondary"
        >Back</a
      >
      <div class="d-flex align-items-center">
        <img
          src="/static/images/logo.png"
          alt="Logo"
          style="height: 40px; margin-right: 10px"
        />
        <div class="brand">
          <span class="black">Collect</span><span class="red">ive</span>
        </div>
      </div>
    </div>

    <div class="page-wrapper">
      <div class="content-wrapper container py-4">
        <!-- Course Header -->
        <div class="course-header">
          <h1 class="mb-2">{{ study_material.title }}</h1>
          <p>{{ study_material.description }}</p>
          <hr />
          <h5>Course Details</h5>
          <p>
            <strong>Start Date:</strong>
            {{ user_progress.start_date.strftime('%Y-%m-%d %H:%M:%S') if
            user_progress.start_date else 'Not started yet' }}
          </p>
          <p>
            <strong>Maximum Days Allowed:</strong> {{ study_material.max_time }}
          </p>
          <p>
            <strong>Time Spent (This Session):</strong>
            <span id="timeSpentDisplay">0s</span>
          </p>
        </div>

        <!-- Course Content -->
        <h4 class="fw-bold text-primary border-bottom pb-2 mb-3">
          Course Content
        </h4>
        {% if documents %} {% for document in documents %}
        <div class="card mb-4">
          <div class="card-body">
            {% if document.type == 'pdf' %}
            <div id="pdf-container-{{ document.id }}" class="pdf-viewer"></div>
            <div
              id="nav-controls-{{ document.id }}"
              class="nav-controls mt-2"
            ></div>

            <script>
              pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";

              const pdfUrl{{ document.id }} = "{{ url_for('study_material_routes.stream_file', file_id=document.id) }}";
              const pdfContainer{{ document.id }} = document.getElementById("pdf-container-{{ document.id }}");
              const navControls{{ document.id }} = document.getElementById("nav-controls-{{ document.id }}");

              let currentPage{{ document.id }} = 1;
              let pdfInstance{{ document.id }} = null;

              function renderPDFPage(pdf, pageNum) {
                pdf.getPage(pageNum).then(page => {
                  const containerWidth = pdfContainer{{ document.id }}.clientWidth;
                  const scale = (containerWidth - 40) / page.getViewport({ scale: 1 }).width;
                  const viewport = page.getViewport({ scale });

                  const canvas = document.createElement("canvas");
                  const context = canvas.getContext("2d");
                  canvas.height = viewport.height;
                  canvas.width = viewport.width;
                  canvas.style.maxWidth = "100%";
                  canvas.style.height = "auto";

                  pdfContainer{{ document.id }}.innerHTML = "";
                  pdfContainer{{ document.id }}.appendChild(canvas);

                  page.render({ canvasContext: context, viewport }).promise.then(() => {
                    updateProgress({ pageNum, totalPages: pdf.numPages });
                  });
                }).catch(err => {
                  pdfContainer{{ document.id }}.innerHTML = "<p>Error rendering page.</p>";
                  console.error("Error rendering page:", err);
                });
              }

              function updateProgress({ pageNum, totalPages }) {
                fetch("{{ url_for('study_material_routes.update_progress') }}", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() }}"
                  },
                  body: JSON.stringify({
                    study_material_id: "{{ study_material.id }}",
                    current_page: pageNum,
                    total_pages: totalPages
                  })
                })
                .then(res => res.json())
                .then(data => {
                  if (data.error) console.error("Progress error:", data.error);
                })
                .catch(err => console.error("Progress update failed:", err));
              }

              pdfjsLib.getDocument(pdfUrl{{ document.id }}).promise.then(pdf => {
                pdfInstance{{ document.id }} = pdf;
                renderPDFPage(pdf, currentPage{{ document.id }});

                navControls{{ document.id }}.innerHTML = `
                  <button class="btn btn-primary btn-sm" id="prev-{{ document.id }}">Previous</button>
                  <button class="btn btn-primary btn-sm" id="next-{{ document.id }}">Next</button>
                  <span class="ms-2">Page <span id="page-num-{{ document.id }}">1</span> of ${pdf.numPages}</span>
                `;

                document.getElementById(`prev-{{ document.id }}`).addEventListener("click", () => {
                  if (currentPage{{ document.id }} > 1) {
                    currentPage{{ document.id }}--;
                    renderPDFPage(pdfInstance{{ document.id }}, currentPage{{ document.id }});
                    document.getElementById(`page-num-{{ document.id }}`).textContent = currentPage{{ document.id }};
                  }
                });

                document.getElementById(`next-{{ document.id }}`).addEventListener("click", () => {
                  if (currentPage{{ document.id }} < pdf.numPages) {
                    currentPage{{ document.id }}++;
                    renderPDFPage(pdfInstance{{ document.id }}, currentPage{{ document.id }});
                    document.getElementById(`page-num-{{ document.id }}`).textContent = currentPage{{ document.id }};
                  }
                });

                const resizeObserver = new ResizeObserver(() => {
                  renderPDFPage(pdfInstance{{ document.id }}, currentPage{{ document.id }});
                });
                resizeObserver.observe(pdfContainer{{ document.id }});
              }).catch(err => {
                pdfContainer{{ document.id }}.innerHTML = "<p>Failed to load PDF.</p>";
                console.error("PDF load error:", err);
              });
            </script>
            {% elif document.type == 'text' %}
            <pre class="border p-3 bg-light rounded">
{{ document.content }}</pre
            >
            {% else %}
            <p>Preview not available for this file type.</p>
            {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <p class="text-muted">No course content uploaded for this course.</p>
        {% endif %}

        <!-- Progress -->
        <div class="mt-4">
          <h5>Progress</h5>
          <div class="progress">
            <div
              class="progress-bar"
              role="progressbar"
              style="width: {{ user_progress.progress_percentage }}%;"
            >
              {{ user_progress.progress_percentage }}%
            </div>
          </div>
        </div>
      </div>

      <footer class="bg-dark text-light text-center py-3">
        <p class="mb-0">Collective IntranetÂ© 2024</p>
      </footer>
    </div>

    <script>
      const idleThreshold = 15 * 60 * 1000;
      let idleTime = 0;

      function resetIdleTime() {
        idleTime = 0;
      }
      function checkIdleTime() {
        idleTime += 1000;
        if (idleTime >= idleThreshold) {
          window.location.href = "{{ url_for('auth_routes.logout') }}";
        }
      }

      document.addEventListener("mousemove", resetIdleTime);
      document.addEventListener("keydown", resetIdleTime);
      document.addEventListener("click", resetIdleTime);
      setInterval(checkIdleTime, 1000);

      // Time Tracking
      let elapsedTime = 0;
      const updateInterval = 30000;
      const studyMaterialId = "{{ study_material.id }}";

      function updateTimerDisplay() {
        const displayElem = document.getElementById("timeSpentDisplay");
        if (displayElem) {
          displayElem.textContent = `${elapsedTime}s`;
        }
      }

      setInterval(() => {
        elapsedTime += updateInterval / 1000;
        updateTimerDisplay();

        fetch("{{ url_for('study_material_routes.update_time') }}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}",
          },
          body: JSON.stringify({
            study_material_id: studyMaterialId,
            elapsed_time: updateInterval / 1000,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) console.error("Time update error:", data.error);
          })
          .catch((err) => console.error("Error updating time:", err));
      }, updateInterval);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
