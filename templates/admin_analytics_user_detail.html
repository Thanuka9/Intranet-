{% extends 'admin_base.html' %} {% block title %}User Analytics{% endblock %} {%
block content %}
<h2 class="mb-4">User: {{ user.first_name }} {{ user.last_name }}</h2>
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <strong>Email:</strong> {{ user.employee_email }}<br />
        <strong>Department:</strong> {{ user.department.name if user.department
        else '-' }}<br />
        <strong>Designation:</strong> {{ user.designation.title if
        user.designation else '-' }}<br />
        <strong>Join Date:</strong> {{ user.join_date.strftime('%Y-%m-%d') if
        user.join_date else '-' }}<br />
        <strong>Current Level:</strong> {{ user.get_current_level() }}
      </div>
    </div>
  </div>
</div>
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Exam Scores</div>
      <div class="card-body">
        {% if exam_titles|length == 1 %}
        <div class="text-center mb-4">
          <canvas id="gaugeChart" width="200" height="100"></canvas>
          <div class="mt-2">
            <span
              class="fw-bold fs-4 {% if exam_scores[0] >= 80 %}text-success{% elif exam_scores[0] < 50 %}text-danger{% else %}text-secondary{% endif %}"
            >
              {{ exam_scores[0] }}%
            </span>
            <span class="ms-2">({{ exam_titles[0] }})</span>
          </div>
        </div>
        {% else %}
        <canvas id="userExamChart"></canvas>
        {% endif %}
        <table class="table table-sm mt-3">
          <thead>
            <tr>
              <th>Exam</th>
              <th>Score</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for i in range(exam_titles|length) %}
            <tr>
              <td>{{ exam_titles[i] }}</td>
              <td>
                <span
                  class="{% if exam_scores[i] >= 80 %}text-success{% elif exam_scores[i] < 50 %}text-danger{% else %}text-secondary{% endif %}"
                >
                  {{ exam_scores[i] }}%
                </span>
              </td>
              <td>{{ exam_dates[i] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header">Course Progress</div>
      <div class="card-body">
        <canvas id="userCourseChart"></canvas>
        <table class="table table-sm mt-3">
          <thead>
            <tr>
              <th>Course</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody>
            {% for i in range(course_titles|length) %}
            <tr>
              <td>{{ course_titles[i] }}</td>
              <td>
                <div class="progress" style="height: 16px">
                  <div
                    class="progress-bar {% if course_percents[i] >= 80 %}bg-success {% elif course_percents[i] < 50 %}bg-danger {% else %}bg-warning{% endif %}"
                    role="progressbar"
                    style="width: {{ course_percents[i] }}%"
                  >
                    {{ course_percents[i] }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="mb-4">
  <h4>Activity Timeline</h4>
  <ul class="timeline">
    {% for event in timeline %}
    <li>
      <strong>{{ event[1] }}</strong> â€“ {{ event[2] }} {% if event[0] %}<span
        class="text-muted"
        >({{ event[0].strftime('%Y-%m-%d') }})</span
      >{% endif %}
    </li>
    {% endfor %}
  </ul>
</div>

<!-- Special Exam Results Section -->
<div class="card shadow-sm mb-4">
  <div class="card-header">
    <h4 class="mb-0">Special Exam Results</h4>
  </div>
  <div class="card-body">
    {% if special_exam_record %}
    <div class="row">
      <div class="col-md-6">
        <h5>Paper 1</h5>
        <ul class="list-unstyled">
          <li><strong>Score:</strong> {{ special_exam_record.paper1_score if special_exam_record.paper1_score is not none else 'N/A' }}</li>
          <li><strong>Status:</strong>
            {% if special_exam_record.paper1_completed_at %}
              {% if special_exam_record.paper1_passed %}
                <span class="badge bg-success">Passed</span>
              {% else %}
                <span class="badge bg-danger">Failed</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary">Not Attempted</span>
            {% endif %}
          </li>
          <li><strong>Time Spent:</strong> {{ special_exam_record.paper1_time_spent ~ ' minutes' if special_exam_record.paper1_time_spent is not none else 'N/A' }}</li>
          <li><strong>Completed At:</strong> {{ special_exam_record.paper1_completed_at.strftime('%Y-%m-%d %H:%M') if special_exam_record.paper1_completed_at else 'N/A' }}</li>
          <li><strong>Attempts:</strong> {{ special_exam_record.paper1_attempts if special_exam_record.paper1_attempts is not none else 'N/A' }}</li>
        </ul>
      </div>
      <div class="col-md-6">
        <h5>Paper 2</h5>
        <ul class="list-unstyled">
          <li><strong>Score:</strong> {{ special_exam_record.paper2_score if special_exam_record.paper2_score is not none else 'N/A' }}</li>
          <li><strong>Status:</strong>
            {% if special_exam_record.paper2_completed_at %}
              {% if special_exam_record.paper2_passed %}
                <span class="badge bg-success">Passed</span>
              {% else %}
                <span class="badge bg-danger">Failed</span>
              {% endif %}
            {% else %}
              <span class="badge bg-secondary">Not Attempted</span>
            {% endif %}
          </li>
          <li><strong>Time Spent:</strong> {{ special_exam_record.paper2_time_spent ~ ' minutes' if special_exam_record.paper2_time_spent is not none else 'N/A' }}</li>
          <li><strong>Completed At:</strong> {{ special_exam_record.paper2_completed_at.strftime('%Y-%m-%d %H:%M') if special_exam_record.paper2_completed_at else 'N/A' }}</li>
          <li><strong>Attempts:</strong> {{ special_exam_record.paper2_attempts if special_exam_record.paper2_attempts is not none else 'N/A' }}</li>
        </ul>
      </div>
    </div>
    {% else %}
    <p class="text-muted">No special exam records found for this user.</p>
    {% endif %}
  </div>
</div>

<a
  href="{{ url_for('admin_routes.analytics_user_list') }}"
  class="btn btn-outline-secondary"
  >&larr; Back to User List</a
>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
  const examTitles = {{ exam_titles|tojson }};
  const examScores = {{ exam_scores|tojson }};
  const courseTitles = {{ course_titles|tojson }};
  const coursePercents = {{ course_percents|tojson }};

  document.addEventListener('DOMContentLoaded', () => {
    {% if exam_titles|length > 1 %}
    new Chart(document.getElementById('userExamChart'), {
      type: 'bar',
      data: {
        labels: examTitles,
        datasets: [{
          label: 'Score (%)',
          data: examScores,
          backgroundColor: examScores.map(score =>
            score >= 80 ? '#27ae60' : (score < 50 ? '#e74c3c' : '#f39c12'))
        }]
      },
      options: {
        indexAxis: 'y',
        scales: { x: { beginAtZero: true, max: 100 } },
        plugins: {
          datalabels: {
            anchor: 'end',
            align: 'right',
            formatter: Math.round,
            color: '#333'
          }
        }
      },
      plugins: [ChartDataLabels]
    });
    {% elif exam_titles|length == 1 %}
    // Gauge chart for single exam (using doughnut with rotation)
    const ctx = document.getElementById('gaugeChart').getContext('2d');
    const score = examScores[0];
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Score', 'Remaining'],
        datasets: [{
          data: [score, 100-score],
          backgroundColor: [
            score >= 80 ? '#27ae60' : (score < 50 ? '#e74c3c' : '#f39c12'),
            '#e0e0e0'
          ],
          borderWidth: 0
        }]
      },
      options: {
        rotation: Math.PI,
        circumference: Math.PI,
        cutout: '70%',
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false },
          datalabels: {
            display: false
          }
        }
      }
    });
    {% endif %}

    // Course progress
    new Chart(document.getElementById('userCourseChart'), {
      type: 'bar',
      data: {
        labels: courseTitles,
        datasets: [{
          label: 'Progress (%)',
          data: coursePercents,
          backgroundColor: coursePercents.map(p =>
            p >= 80 ? '#27ae60' : (p < 50 ? '#e74c3c' : '#f39c12'))
        }]
      },
      options: {
        indexAxis: 'y',
        scales: { x: { beginAtZero: true, max: 100 } },
        plugins: { legend: { display: false } }
      }
    });
  });
</script>
<style>
  /* Simple vertical timeline style */
  .timeline {
    list-style: none;
    padding-left: 0;
  }
  .timeline li {
    border-left: 2px solid #bdc3c7;
    margin-left: 10px;
    padding-left: 16px;
    margin-bottom: 10px;
    position: relative;
  }
  .timeline li:before {
    content: "";
    position: absolute;
    left: -7px;
    top: 7px;
    width: 10px;
    height: 10px;
    background: #2980b9;
    border-radius: 50%;
  }
</style>
{% endblock %}
